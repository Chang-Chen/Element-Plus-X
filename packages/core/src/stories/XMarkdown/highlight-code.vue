<script setup lang="ts">
import type {
  CodeBlockExpose,
  CodeBlockHeaderExpose
} from '@components/XMarkdownCore/components/CodeBlock/shiki-header';
import XMarkdown from '@components/XMarkdown/index.vue';
import { ElButton, ElSpace, ElTooltip } from 'element-plus';
import { h } from 'vue';
import CodeHeader from './CodeHeader.vue';

const props = defineProps<{
  markdown: string;
}>();
const timer = ref();
const index = ref(0);
function start() {
  timer.value = setInterval(() => {
    index.value += 100;
    if (index.value > props.markdown.length) {
      clearInterval(timer.value);
      index.value = props.markdown.length;
    }
  }, 100);
}
function pause() {
  if (timer.value) {
    clearInterval(timer.value);
    timer.value = null;
  }
}

const content = computed(() => {
  return props.markdown.slice(0, index.value);
});

const codeXSlotConfig: CodeBlockHeaderExpose = {
  codeHeaderLanguage: (props: CodeBlockExpose) => {
    return h(
      'span',
      { onClick: (ev: MouseEvent) => props.toggleExpand(ev) },
      {
        default: () => '点击切换折叠状态'
      }
    );
  },
  codeHeaderControl: (props: CodeBlockExpose) => {
    return h(
      ElSpace,
      {
        class: `markdown-language-header-space`,
        direction: 'horizontal'
      },
      {
        default: () => [
          h(
            ElTooltip,
            {
              content: '切换主题',
              placement: 'top'
            },
            {
              default: () =>
                h(
                  ElButton,
                  {
                    class: 'shiki-header-button',
                    onClick: () => {
                      props.toggleTheme();
                      console.log('isDark', props.isDark.value);
                    }
                  },
                  { default: () => (props.isDark.value ? '🌞' : '🌙') }
                )
            }
          ),
          h(
            ElTooltip,
            {
              content: '复制代码',
              placement: 'top'
            },
            {
              default: () =>
                h(
                  ElButton,
                  {
                    class: 'shiki-header-button',
                    onClick: () => {
                      props.copyCode(props.renderLines);
                    }
                  },
                  { default: () => '🥢' }
                )
            }
          )
        ]
      }
    );
  }
};

const codeXSlotComponentsConfig: CodeBlockHeaderExpose = {
  codeHeaderLanguage: CodeHeader
};

function redo() {
  index.value = 0;
  if (timer.value) {
    clearInterval(timer.value);
    timer.value = null;
  }
  start();
}
onMounted(() => {
  start();
});
</script>

<template>
  <ElButton @click="start"> 开始 </ElButton>
  <ElButton @click="pause"> 暂停 </ElButton>
  <ElButton @click="redo"> 重新开始 </ElButton>
  <div class="component-container">
    <h4>默认插槽</h4>
    <XMarkdown
      v-bind="$attrs"
      :markdown="content"
      :color-replacements="{
        // 这里传一个默认值 使其不受到其他 colorReplacements 的影响
        'vitesse-light': {
          '#ab5959': '#ab5959',
          '#1e754f': '#1e754f'
        },
        'vitesse-dark': {
          '#cb7676': '#cb7676',
          '#4d9375': '#4d9375'
        }
      }"
      :custom-attrs="{
        code: () => {
          return {
            name: 'code',
            class: 'inline-code'
          };
        },
        a: _ => ({
          target: '_blank',
          rel: 'noopener noreferrer'
        })
      }"
    />
    <h4>函数插槽以及使用暴露出来的方法 和 自定义当前主题的颜色</h4>
    <XMarkdown
      v-bind="$attrs"
      :markdown="content"
      :code-x-slot="codeXSlotConfig"
    />
    <h4>组件插槽</h4>
    <XMarkdown
      v-bind="$attrs"
      :markdown="content"
      :code-x-slot="codeXSlotComponentsConfig"
    />
  </div>
</template>

<style scoped lang="scss">
.component-container {
  background-color: white;
  padding: 12px;
  border-radius: 15px;
}
</style>
